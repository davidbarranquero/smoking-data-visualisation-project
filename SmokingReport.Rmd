---
title: "Smoking and Vaping Trends in the United States"
author: "David Barranquero"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r, echo=F, message=F, include=F}
setwd('/Users/davidbarranquero/Desktop/ /Uni/UNI Grad/GitHubProjects')
```
\newpage

## Introduction

This project explores the prevalence of smoking in the United States and the emerging vaping trends among youth. These trends are of great importance to health researchers, medical professionals and governments as they are a key component in understanding the overall health of a population. We aim to understand where the United States sits globally in terms of smoking trends, understand what patterns have emerged in the past few decades, and moreover where is the US likely heading with smoking and vaping trends among its youth. 


## Questions/Aims
The first question to be asked is what are the global trends in cigarette smoking rates? This question aims to establish the wider picture of overall trends in recent years, and reveal the US's place in the wider trends.

Next we wish to again look at the United States as a whole and ask what have been the trends in smoking rates in the United States from 1995 to 2010? We want to facet by geographic region in the Northeast, Midwest, South and West, and also by smoking frequency, exploring daily smokers, weekly smokers, former smokers, and non-smokers?

Furthermore, we wish to look specifically at the years from 2005 to 2009 and determine what are the largest costs to the state associated with cigarette smoking. Regarding trends in sex, we want to explore the percentage of male deaths from smoking in this time period is the same with that of females, when averaged among the states. We also wish to explore if there is a correlation between the overall cost to a state, and the number of individuals dying from smoking related illnesses.

Finally, we wish to look at the trends in vaping and e-cigarette usage among youth from 2011-2020 and see if we can predict their smoker status based on their age, sex, vaping status and frequency.

## Results

### Section A: Global Smoking Trends
While this report examines the trends and patterns in smoking rates and cigarette use through the lens of the United States, it is important to consider the patterns in the United States in a macroscopic form, as part of a wider context of trends and patterns around the globe.

We begin first by examining the global trends in the data using non-parametric regression.

```{r, include=F}
library(tidyverse)

# Loading our data set
who_smoking <- read_csv('SmokingData/WHOSmokingAndTobaccoData.csv') %>% 
  rename(country = Location, smoke = CigaretteSmokingPrevalence, year=Year) %>% 
  select(country, smoke, year)

# Wrangling our data to separate the confidence intervals
who_smoking <- who_smoking %>% 
  rowwise() %>% 
  mutate(array = str_split(smoke, " ")) %>% 
  mutate(smokers = array[1]) %>% 
  mutate(lower = substring(array[2], 2, nchar(array[2]))) %>% 
  mutate(upper = substring(array[4], 1, nchar(array[4])-1)) %>% 
  select(country, smokers, lower, upper, year)

# Casting values to numerical
who_smoking$smokers <- as.numeric(who_smoking$smokers)
who_smoking$lower <- as.numeric(who_smoking$lower)
who_smoking$upper <- as.numeric(who_smoking$upper)
```

```{r}
# We plot the points and the overall mean for each year.
who_smoking %>% ggplot(aes(x=year, y=smokers, col=country)) + 
  geom_point(alpha=0.5, position = 'jitter') + 
  geom_line(y=20, col='black') + 
  stat_summary(geom = "point",fun = "mean", col = "red", size=3) + 
  scale_x_continuous(breaks = seq(2008,2018,2)) + 
  theme(legend.position = "none") + 
  ggtitle("Figure 1: Average Smoking Percentage of Countries (2008-2018)") + 
  labs(x='Year', y='Smoking Percentage of Population') 
```

Figure 1 presents the mean smoking percentage for 149 countries from 2008 to 2018. We can see there is an overall downward trend to the mean smoking percentage in this time, averaging 22.16% in 2008, and 18.97% by 2018. Most countries tend to be centered around the 10%-30% smoking population range, with clusters around the 0-5% and a scattering of outliers above 30%.

Furthermore we can examine the top ten countries by smoking rates per year, and the United States in relation to these countries for both 2008 and 2018.

```{r, echo=FALSE, message=FALSE, out.width="50%", fig.show='hold'}
# We separate all 2008 records, and arrange from most to least.
# Then construct a sideways bar char on the most heavily smoking countries
s08 <- who_smoking %>% 
  filter(year==2008) %>% 
  arrange(desc(smokers))
s08 <- s08[c(seq(1:10), 84),]
s08 %>% ggplot() +
  geom_bar(aes(x=smokers, 
               y=factor(country, levels=rev(country)), 
               fill=country),
           stat="identity") +
  theme(legend.position = "none") + 
  ggtitle("Figure 2.1: Top 10 Smoking Countries and USA", subtitle = "2008") + 
  labs(x= "Percentage of Smokers", y="Countries") + 
  scale_x_continuous(breaks = seq(0,50,10)) + 
  expand_limits(x=c(0,50))

# We do the same process for the 2018 data set, separate the data, and plot.
s18 <- who_smoking %>% 
  filter(year==2018) %>% 
  arrange(desc(smokers))
s18 <- s18[c(seq(1:10), 79),]
s18 %>% ggplot() +
  geom_bar(aes(x=smokers, 
               y=factor(country, levels=rev(country)), 
               fill=country),
           stat="identity") +
  theme(legend.position = "none") + 
  ggtitle("Figure 2.2: Top 10 Smoking Countries and USA", subtitle = "2018") + 
  labs(x= "Percentage of Smokers", y="Countries") + 
  scale_x_continuous(breaks = seq(0,50,10)) + 
  expand_limits(x=c(0,50))
```



We observe from Figures 2.1 and 2.2 that even among the heaviest of smokers, there has been a downward trend in smoking habits for these nations in the decade from 2008 to 2018. Furthermore we observe that the US's smoking percentage is less than half of that of the largest smoking nation for 2008, Laos, and approaching a third of the smoking rate of the heaviest smoker in 2018, Albania. What can be concluded from this is that despite the massive consumption of cigarettes in the US throughout the 20th century, in the 21st century, after numerous revelations on the long terms adverse effects of smoking, the United States is no longer a smoking nation relative to the rest of the world. According to this World Health Organisation data set, in 2008 they ranked 84th in terms of smoking percentage of population, and 79th in 2018.

If we examine the overall smoking trend in the US from this data set, we can clearly see a strong decline in smoking percentages, even within the last decade.


```{r, echo=FALSE, message=FALSE, out.width="90%"}
# To construct the confidence intervals we get all the years from the US
x1 <- unlist(who_smoking %>% filter(country == 'United States of America') %>% select(year))

# And reverse them too
x2 <- rev(x1)

# Then join these as x coordinates
xval = union_all(x1, x2)

# Repeat for y values, the upper and Lower CI's
y1 <- unlist(who_smoking %>% filter(country == 'United States of America') %>% select(lower))
y2 <- unlist(who_smoking %>% filter(country == 'United States of America') %>% select(upper))
yval <- union_all(y1,rev(y2))

# Also get the values of the line we're plotting  
smoke <- unlist(who_smoking %>% filter(country == 'United States of America') %>% select(smokers))

# We plot the line and construct a polygon for the 95% CI
ggplot() + 
  geom_line(aes(x1, y1, col='red')) + 
  geom_line(aes(x1, y2, col='red')) +
  geom_line(aes(x1, smoke)) +
  geom_polygon(aes(x=xval, y=yval), alpha=0.1, fill='red') + 
  theme(legend.position = 'none') +
  ggtitle('Figure 3: US Total Smoking Rates with 95% Confidence Intervals', 
  subtitle= '2008-2018') + 
  labs(x='Year', y='Smoking Percentage of Adult Population') + 
  scale_x_continuous(breaks = seq(2008,2018,2))
```

In 2008, approximately 21.5% of US citizens were smokers, with a 95% confidence interval of [18.3, 25.0]. In 2018, this had decreased to 17.1%, with a 95% confidence interval of [14.2, 20.3]. This represents a relative percentage decrease of just over 20% in a decade. However, it should be noted that an increase from 18.3 to 20.3 from 2008 to 2018 would fit within the confidence intervals, so we should be wary from making too strong an assertion from this data alone. From here, we will examine smoking trends in the United States from 1995 to 2010, and explore the impacts of long term mass consumption of cigarettes and tobacco on the nation.

### Section B: US Smoking Trends

```{r include=F}
# Load the smoking data
usa_smoking_data <- read_csv('SmokingData/BRFSS_Prevalence_and_Trends_Data__Tobacco_Use_-_Four_Level_Smoking_Data_for_1995-2010.csv')

# Creating our data set, removing the territories and aggregates but keeping DC.
usa_statesdc <- usa_smoking_data %>% group_by(State) %>% 
  filter(!State %in% c('Guam',
                       'Nationwide (States and DC)', 
                       'Nationwide (States, DC, and Territories)',
                       'Virgin Islands',
                       'Puerto Rico')) %>%
  ungroup() %>%
  arrange(State, Year)

# Wrangling the Data, to clean it up, and creating a long view to be able to facet on the smoking frequencies.
usa_statesdc <- usa_statesdc %>% 
  mutate(State = factor(State)) %>% 
  rename(year=Year,
         state=State,
         daily=`Smoke everyday`, 
         casual=`Smoke some days`, 
         former=`Former smoker`, 
         never=`Never smoked`, 
         location=`Location 1`)

# Pivot longer so we can facet on smoking frequency
usa_statesdc_long <- usa_statesdc %>% 
  pivot_longer(cols = c(daily, casual, former, never)) %>%
  rename(frequency=name, amount=value) %>%
  mutate(frequency = factor(frequency, 
                            levels = c("daily", "casual", "former", "never")))
```


```{r}
# We do a spaghetti plot, facetting on smoking frequency
ggplot(usa_statesdc_long,aes(x=year,y=amount,col=frequency)) + 
  geom_smooth(formula = 'y~x',method='lm') + 
  geom_line(aes(group=state), alpha=0.2) +
  facet_grid(.~frequency, scales = "free", space = "free") +
  ggtitle('Figure 4: USA Smoking trends from 1995-2010', 
          subtitle = 'Separated by Smoking Frequencies') + 
  labs(x='Year', y='Percentage of US population that smokes') + 
  theme(panel.spacing = unit(2, "lines"), legend.position = 'none')
```

If we examine Figure 4 above, we can see that there has been change in smoking frequencies in the United States from 1995 to 2010. The most notable difference is the decline in daily smokers over this time period from approximately 20% of the United States population to approximately 13%. Furthermore, the rate of non-smokers in this time period has also seen an increase from about 52% to 57%. The proportions of casual smokers has remained relatively constant in increasing only from 3% to 5% from 1995 to 2010. Finally, the proportions of former smokers has remained steady at 25% throughout this period. As the rate of former smokers has remained relatively constant in this time period, but the rate of daily smokers has decreased and the rate of non-smokers has increased, we can deduce that the change in trends is not daily smokers quitting, but more likely a new generation not beginning smoking in the first place. Furthermore, the decrease in daily smokers most likely a result of individuals passing away from health complications caused from long-term cigarette consumption. We observe that for all smoking frequencies except casual, there is notable variation in the smoking trends of US states from 1995 to 2010. There may be regional influences in the data that may explain the nature of this variation. If we facet on the four major geographical regions of the United States, West, Midwest, Northeast and South, we observe that there is geographic variation in the different smoking trends.
```{r}
# To add regions to the data, we perform a mapping
library(forcats)
usa_statesdc_long <- usa_statesdc_long %>% 
  mutate(region = fct_collapse(state, 
                               West = c("Alaska", "Arizona", "California",
                                        "Colorado", "Hawaii", "Idaho",
                                        "Montana", "Nevada", "New Mexico",
                                        "Oregon", "Utah", "Washington",
                                        "Wyoming"),
                               Midwest = c("Illinois", "Indiana", "Iowa",
                                            "Kansas",  "Michigan", "Minnesota",
                                            "Missouri", "Nebraska", "North Dakota",
                                            "Ohio", "South Dakota", "Wisconsin"),
                               Northeast = c("Connecticut", "Maine", "Massachusetts",
                                             "New Hampshire", "New Jersey", "New York",
                                             "Pennsylvania", "Rhode Island", "Vermont"),
                               South = c("Alabama", "Arkansas", "Delaware",
                                         "District of Columbia", "Florida", "Georgia",
                                         "Kentucky", "Louisiana", "Maryland",
                                         "Mississippi", "North Carolina", "Oklahoma",
                                         "South Carolina", "Tennessee", "Texas",
                                         "Virginia", "West Virginia")))
```


```{r, echo=FALSE, message=FALSE, out.width="50%", fig.show='hold'}
# We plot the lines for daily smokers, broken up by regions
usa_statesdc_long %>% filter(frequency == "daily") %>% group_by(region, year) %>%
  summarise(year, avg = mean(amount), region) %>%
ggplot() + 
  geom_line(aes(x=year,y=avg,col=region)) + 
  ggtitle("Figure 5.1: Daily Smokers") + 
  labs(x='Year', y='Percentage of US population that smokes', col='Region') + 
  theme(panel.spacing = unit(2, "lines"), 
        plot.title = element_text(hjust = 0.5))

# We plot the lines for casual smokers, broken up by regions
usa_statesdc_long %>% filter(frequency == "casual") %>% group_by(region, year) %>%
  summarise(year, avg = mean(amount), region) %>%
ggplot() + 
  geom_line(aes(x=year,y=avg,col=region)) + 
  ggtitle("Figure 5.2: Casual Smokers") + 
  labs(x='Year', y='Percentage of US population that smokes', col='Region') + 
  theme(panel.spacing = unit(2, "lines"), 
        plot.title = element_text(hjust = 0.5))
```

Observing the trends among regions, there is a consistent nature to the decline in the proportion of daily smokers, and although there's frequent interweaving, the proportion of casual smokers among the different regions are all fairly similar. There is an interesting change in the trends in casual smoking from a consistent increase from 1995 to 2001 to leveling out from 2001 to 2010. The proportion of daily smokers also experiences a sharp uptick in 2001 for all regions before again continuing its downward trend from 2003 onward. Given the evolving geo-political tensions at the time with the 9/11 terrorist attacks, it would be unsurprising if these trends were from a direct result of the events of 9/11, with many Americans turning to smoking to deal with the stress of the time. 

```{r, echo=FALSE, message=FALSE, out.width="50%", fig.show='hold'}
# We plot the lines for former smokers, broken up by region
usa_statesdc_long %>% filter(frequency == "former") %>% group_by(region, year) %>%
  summarise(year, avg = mean(amount), region) %>%
ggplot() + 
  geom_line(aes(x=year,y=avg,col=region)) + 
  ggtitle("Figure 5.3: Former Smokers") + 
  labs(x='Year', y='Percentage of US population that smokes', col='Region')

# We plot the lines for non-smokers, broken up by region
usa_statesdc_long %>% filter(frequency == "never") %>% group_by(region, year) %>%
  summarise(year, avg = mean(amount), region) %>%
ggplot() + 
  geom_line(aes(x=year,y=avg,col=region)) + 
  ggtitle("Figure 5.4: Non-Smokers") + 
  labs(x='Year', y='Percentage of US population that smokes', col='Region') + 
  theme(panel.spacing = unit(2, "lines"), 
        plot.title = element_text(hjust = 0.5))
```

The differences in trends for former smokers are quite pronounced with the West experiencing a decrease in former smokers from 1995 to 2010, while the South, West and Midwest all experienced an increase. Furthermore there is a large difference in the population percentage of former smokers among regions with the former smoker population percentage of the South being roughly 6% less than that of the Northeast. With regards to non-smokers, all states are experiencing an increase of non-smokers in their population. While the increases in the Northeast, West and Midwest are roughly similar, the South has experienced a far more gradual increase. 

In comparing regions, the South exceeds the other regions in smoking consumption, having the largest population percentages in daily and casual smoking in 2010, and the lowest percentages in former and non-smokers. The reason for this is likely historical with the intertwined nature of Southern economic prosperity and tobacco cultivation.

```{r, echo=F, include=F, message=F}
# We read in our Deaths and Costs Data
library("readxl")
smoking_costs_full <- read_csv("SmokingData/Smoking-Attributable_Mortality__Morbidity__and_Economic_Costs__SAMMEC__-_Smoking-Attributable_Expenditures__SAE_.csv")

smoking_deaths_full <- read_csv("SmokingData/Smoking-Attributable_Mortality__Morbidity__and_Economic_Costs__SAMMEC__-_Smoking-Attributable_Mortality__SAM_.csv")
```


```{r}
#Adding total_smokers and current_smokers variable
usa_statesdc <- usa_statesdc %>%
  group_by(state, year) %>% 
  mutate(total_smokers = sum(daily, casual, former)) %>% 
  mutate(current_smokers = sum(daily, casual)) %>%
  ungroup
```


```{r}
# Filter the large dataset to just 2005-09 so that we can pair witht the deaths and costs datasets
usa_statesdc_0509 <- usa_statesdc %>%
  select(year, state, total_smokers) %>% 
  filter(year %in% c('2005', '2006', '2007', '2008', '2009'))

smoking_costs <- smoking_costs_full %>% filter(Variable == 'Total') %>%
  select(Year, LocationDesc, Data_Value) %>%
  rename(year = Year,
         state = LocationDesc,
         cost = Data_Value) %>%
  arrange(state, year)

usa_statesdc_0509 <- inner_join(usa_statesdc_0509, smoking_costs, by=c("state", "year")) %>%
  mutate(state = factor(state))

usa_regions <- usa_statesdc_long %>% distinct(state, region)

usa_statesdc_0509 <- inner_join(usa_statesdc_0509, usa_regions, by=c("state"))
```

```{r, echo=FALSE, message=FALSE ,fig.keep='all', out.width="90%"}
# Plot the overall costs trends for 2005-2009 by region
usa_statesdc_0509 %>% 
  group_by(region, year) %>%
  summarise(year = year, avg_cost = mean(cost)) %>%
  ggplot(aes(x=year, y=avg_cost, col=region)) + 
  geom_point() + 
  geom_line() + 
  ggtitle("Figure 6: Average Smoking Attributable Economic Cost per Region",
          subtitle = "2005-2009") + 
  labs(x='Year', y='Average Cost (in Millions of USD)', col='Region')
```

Furthermore, the costs of smoking, both financial and in human life, are a major component of the impact of mass cigarette consumption in the United States. If we examine first the financial costs to the United States we can see, from Figure 6, there is a clear consistent increase in economic burden being imposed by smoking in the United States. Across all regions, the trends in economic costs that are attributable to smoking are increasing every year, with the lines of growth appearing parallel. Furthermore, we can break down where exactly these expenses are being generated from. 


```{r, echo=FALSE, message=FALSE, out.width="90%"}
# Now were going to plot the costs but broken up by expenditures
# so that we can see where the costs are coming from
smoking_costs_full %>% 
  group_by(Variable) %>% 
  filter(!Variable == 'Total') %>%
  summarise(Variable, avg = mean(Data_Value)) %>% 
  distinct(Variable, avg) %>% 
  ggplot() + 
  geom_bar(aes(x=factor(Variable, levels = c('Other',
                                             'Nursing Home',
                                             'Ambulatory',
                                             'Prescription Drugs',
                                             'Hospital')),
               y=avg, fill=Variable), stat = 'identity') + 
  ggtitle('Figure 7: Average Yearly Smoking Attributable Expenditure for US', 
          subtitle='2005 - 2009') +
  labs(x='Expenditure', y='Average Cost (in Millions of USD)') + 
  theme(legend.position = 'none')
```

From Figure 7, the Smoking Attributable Economic costs take the form of hospitalization, prescription drugs, ambulatory costs, nursing home requirements and more, averaging a total of \$4.636 billion USD annually. As is clearly displayed, the cost of hospitalization of individuals with smoking attributable illnesses is by far the largest economic cost attributable to smoking, accounting for a national average of $2.364 billion USD annually from 2005-2009 and costs the United States more than the other expenditures combined. Furthermore, if we examine the human cost, there is a large loss of life attributable to smoking related illnesses.

```{r, echo=FALSE, message=FALSE}
# We wrangle the deaths data set to make it usable
smoking_deaths <- smoking_deaths_full %>% 
  select(LocationDesc, MeasureDesc, Data_Value, Gender) %>% 
  rename(state = LocationDesc,
         measure = MeasureDesc,
         deaths = Data_Value,
         sex = Gender) %>%
  arrange(state, sex, desc(measure))

# Reduce to the variables we need
smoking_deaths_short <- smoking_deaths %>%
  filter(measure == 'Average Annual SAM', sex == 'Overall') %>%
  select(state, deaths)

# Because the deaths data set is an average for 2005-2009
# we must also find the average on our large data set
usa_statesdc_deaths <- usa_statesdc %>% 
  filter(year %in% c('2005', '2006', '2007', '2008', '2009')) %>%
  group_by(state) %>%
  summarise(state, smokers = mean(daily)) %>%
  distinct(state, smokers)

# Join all the data sets together
usa_statesdc_deaths <- inner_join(usa_statesdc_deaths, smoking_deaths_short, by='state')
usa_statesdc_deaths <- inner_join(usa_statesdc_deaths, usa_regions, by='state')
```


```{r, echo=FALSE, message=FALSE}
# Pivot wider to put smoking deaths and total deaths on same row
# Then tidy the data
usa_deaths_sex <- inner_join(smoking_deaths, usa_regions, by='state') %>% 
  pivot_wider(names_from = measure, values_from = deaths) %>% 
  rename(avg_smoking_deaths = `Average Annual SAM`,
         avg_total_deaths = `Average Annual Deaths`) %>% 
  mutate(percentage = avg_smoking_deaths/avg_total_deaths)

# Create the summary statistics we want for our table
data <- usa_deaths_sex %>% 
  group_by(sex) %>%
  summarise(sex, 
            smoke = round(mean(avg_smoking_deaths)), 
            total = round(mean(avg_total_deaths)), 
            prop = round(smoke/total,2)) %>% 
  distinct(sex, smoke, total, prop)

# Display the data in a table
library(knitr)
  kable(data, 
      align='c', 
      format='simple', 
      caption='State Average Yearly Smoking Deaths for US (2005-2009)', 
      col.names = c('Sex', 'Smoking Deaths', 'Total Deaths', 'Proportion'))
```

In comparing the differences between men and women, we can see that males are accounting for a larger proportion of smoking deaths than women, averaging 37% of all deaths from 2005 to 2009. Female smoking deaths accounted for 29% of all deaths in the same period. The most pressing statistic however is that overall, 32% or approximately one third of all deaths that occurred in the United States from 2005-2009 were directly attributable to smoking.

Furthermore, if we plot the average number of smoking deaths from 2005-2009 and then average statewide cost in this time, we can see there is a strong positive linear relationship between the two variables. This linear relationship is even clearer with a log transformation of the two variables.

```{r}
# We get the average cost for 2005-2009 per state
costs <- usa_statesdc_0509 %>% 
  group_by(state) %>% 
  summarise(avg_cost = mean(cost)) %>%
  select(state, avg_cost)

# Then combine it with our deaths data
costs_deaths <- inner_join(costs, usa_statesdc_deaths, by='state')
```


```{r, echo=FALSE, message=FALSE, out.width="50%", fig.show='hold'}
# We plot the average cost against the average deaths
ggplot(costs_deaths, aes(x=deaths, y=avg_cost)) + 
  geom_point() + 
  ggtitle('Figure 8.1: Average Smoking Deaths vs. Average Smoking Cost', 
          subtitle='2005-2009') + 
  labs(x='Average Smoking Deaths', 
       y='Average Statewide Cost (in Millions of USD)')

# Then plot the log transform to see how its a more linear relationship
ggplot(costs_deaths, aes(x=log(deaths), y=log(avg_cost))) + 
  geom_point() +
  ggtitle('Figure 8.2: Log of Average Deaths vs. Log of Average Cost', 
          subtitle='2005-2009') + 
  labs(x='Log of Average Smoking Deaths', 
       y='Log of Average Statewide Cost (in Millions of USD)')
```


```{r, include=F, summarise=F}
# We're going to turn our smokers from a percentage to a count
# To see if we can get a better linear relationship with the response
library(readxl)
library(tidyverse)
population <- read_excel('SmokingData/us_population.xlsx')

# Tidy up the data
us_pop <- population %>% 
  pivot_longer(cols=c(`2000`, `2001`, `2002`, `2003`, `2004`,
                      `2005`, `2006`, `2007`, `2008`, `2009`)) %>%
  rename(year=name, population=value) %>% 
  mutate(state = factor(state))

# Select just 2005-2009
us_pop_0509 <- us_pop %>% 
  filter(year %in% c('2005', '2006', '2007', '2008', '2009')) %>%
  group_by(state) %>%
  summarise(state, avg_pop = mean(population)) %>%
  distinct(state, avg_pop)

# Alter costs deaths to now have the % of smokers
# And how many individuals that is
costs_deaths <- inner_join(costs_deaths, us_pop_0509, by='state') %>% 
  mutate(total_smokers = round(smokers*avg_pop/100)) %>% 
  rename(pct_smokers = smokers)

costs_deaths <- costs_deaths %>% 
  mutate(state=factor(state))
```

As such, we will consider a log-log model for this data. We partition our data into a training set and test set, with forty states for training and eleven for testing.

Our model is

$$\log(AverageCost) = \log(Deaths)$$


```{r, include=FALSE, message=FALSE}
# Seed is my student number
library(caret)
library(groupdata2)
set.seed(4760396)

# Create a partition of 40 states for training, 11 for unseen data testing
# Stratify on the response
t_index <- createDataPartition(costs_deaths$avg_cost, p=0.76,list=F)
training_data <- costs_deaths[t_index, ]
test_data <- costs_deaths[-t_index, ]
```


```{r}
# Fit our first model
fit <- lm(log(avg_cost)~log(deaths), training_data)
summary(fit)
bhat = fit$coefficients
```

If we fit our log-log model on the training data set, firstly, the estimate $\hat{\boldsymbol\beta} = (-0.5787, 0.9194)^T$, and hence the equation for the fitted model is $log(\widehat{AVG\_COST}) = -0.5787 + 0.9194 \times log(DEATHS)$.

In looking at model fit, we have a residual standard error of $\tilde\sigma =$ 0.2238 on 38 degrees of freedom, which is very small. The $R^2$ value is 0.9522, indicating that 95.22% of the variation in the response $y$ can be explained by our predictors $X$, Finally, the $R^2_{Adj}$ is 0.951, which is close to the $R^2$ value and indicates a good fit to the data.

Looking at out F and t statistics, the $F$ statistic is 757.7 on 1 and 38 degrees of freedom, resulting in a p-value of less than 2.2e-16, we can thus conclude at $\alpha = 0.05$ significance level that at least one of our regressor coefficients is important to the model. As we only have one predictor, this means that our predictor is significant to the model.

The same conclusion can be reached by observing our t-values. The $t$ value for $\hat\beta_1$ was 27.526, which gives a p-value of less than 2e-16. If we were to conduct the hypothesis test that $\beta_1 = 0$, as the p-value is less than $\alpha = 0.05$ we would conclude that there is sufficient evidence to reject the null hypotheses that $\beta_1 = 0$ at the 5% level of significance.

There were numerous models that were trialed in the selection process for the linear model, however the chosen model was only that satisfied all Ordinary Least Squares assumptions. 

* $\mathbb E[\textbf{e}] = 0$
* $\mathbb V[\textbf{e}] = \sigma^2\bf I$
* $\textbf{e} \sim \mathcal N(0,\sigma^2\bf I)$

Plotting the residuals vs fitted values to test for a linear relationship and constant variance. We can plot histograms of the residuals to confirm they are normal, with mean 0 and constant variance.

```{r, fig.keep='all', out.width="50%", fig.show='hold'}
plot(fit,1)

hist(fit$residuals)
```

There's no clear fanning or patterns to the plot, and so the assumption of homoscedasticity is satisfied. Furthermore the relationship is approximately linear, and so our assumption of mean 0 is satisfied.

There is some evidence of right skew to the histogram, the values are however centered around 0.

If we perform a Shapiro-Wilk test to see if the residuals are normally distributed, we obtain,
```{r}
shapiro.test(fit$residuals)
```

The test returns a p-value > $\alpha=0.05$ so there is insufficient evidence to reject that the residuals are normally distributed with mean 0 and constant variance.

Lastly, we will assess the predictive ability of our model, with the Mean Squared Error (MSE) loss function.
```{r}
# Create a Mean Square Error function
mse <- function(true, pred){
  mean((true-pred)^2)
}
```

```{r}
# Prediction
predicted <- predict(fit, test_data)

# And get the MSE for this run
linear_model_mse <- mse(test_data$avg_cost, exp(predicted))

# Finally, we find out our MSE
print(paste0('Log-Log Model MSE: ', round(linear_model_mse, 2)))
```

Our model in the linear space is defined as 

$$\textbf{y} = e^{\beta_0}\textbf{X}^{\beta_1}$$

which, when converted to the log-transformed space, becomes 

$$ \log(\textbf{y}) = \beta_0 + \beta_1\log(\textbf{X}).$$

A log-transformation is required however in order for the model to fit the data well and still satisfy all OLS assumptions. There may however be an alternative method that may have a stronger predictive ability than the log-log model.

We will consider if we can get a better predictive result using K-nearest neighbours (KNN). We will perform leave-one-out cross validation (LOOCV), but for every potential value of k from 1 to 39 for our data of 40 observations, to find the optimal K to compete against the MSE of the log-log model.

After performing the leave-one-out cross validation for all 39 K's we determine the optimal K is,
```{r}
library(FNN)
# Now for the KNN
  
knn_mse <- rep(0,39)

for (k in seq(1,39)) {
  
  # Perform KNN using this K (with no test data, leave-one-out CV performed)
  knn <- knn.reg(train=training_data$deaths, 
               y=training_data$avg_cost, 
               k=k)
  # We get the average MSE for this K
  knn_mse[k] <- mse(training_data$avg_cost, knn$pred)
}

# We now determine which K had the lowest average MSE.
best_k <- which.min(knn_mse)
print(paste0('K = ', best_k))

```

Thus, K = 4, minimizes the Mean Square Error of the prediction. the performance the KNN model waivers with larger values given the increases separation between points. We can see this by plotting the different MSE's for different K's we can see the performance deteriorating as K increases. This is to be expected, given the large orders of magnitude on the original scale, with more values being used skewing the predictive result.

```{r, echo=FALSE, message=FALSE, out.width="85%"}
# We print out what all the MSE's were for each K
# And show that it rapidly deteriorates for large K
library(scales)
k_val <- seq(1,39)
temp <- data.frame(k = k_val, mse = knn_mse)
ggplot(temp, aes(x=k, y=mse)) + geom_line(colour='blue') + 
  ggtitle('Figure 10: MSE for Different K Values on Training Data') + 
  scale_x_continuous(breaks=seq(0,40,5)) + 
  scale_y_continuous(breaks=seq(0,7000000, 1000000), 
                     labels = comma, 
                     limits = c(0,7000000)) + 
  labs(x='K', y='Avergage Mean Square Error from LOO-CV')
```

Finally, we will use the test data of 11 observations to determine which method performs best on unseen data. The results of this trial were,

```{r}
# We will run the model one last time to get the predicted values for the best K
knn_test <- knn.reg(train=training_data$deaths, 
                      y=training_data$avg_cost, 
                      test=as.data.frame(test_data$deaths),
                      k=best_k)

knn4_mse <- mse(test_data$avg_cost, knn_test$pred)

# Finally, we find out our average MSE
print(paste0('KNN MSE on optimal K: ', round(knn4_mse,2)))
```

We can see, with a MSE of 126285.47, that the log-log model, performed better than the KNN on the optimal K=4, with a MSE of 128185.67. If we plot the two models, using the entire data set, we can see that both models to have a strong fit to the data. The log-log model has far less variation in that it fit's a straight line to the model, in comparison with the KNN model, which mas more variation to fit to individual data points. It is unsurprising that the parametric model has performed best, as the data in the log-transformed space is highly linear, and so imposing a linear form on the data is valid, and yielded better predictive performance.

```{r, out.width="50%", fig.show='hold'}
# We fit the model on the full data for plotting purposes
fit <- lm(log(avg_cost)~log(deaths), costs_deaths)
bhat = fit$coefficients

# And get the KNN predictions for the full data set
knn <- knn.reg(train=costs_deaths$deaths, 
               y=costs_deaths$avg_cost,
               k=4)
knn_pred <- knn$pred

# Plot the log-log model in the original space
ggplot(costs_deaths) + 
  geom_point(mapping=aes(x=deaths, y=avg_cost)) + 
  geom_line(mapping=aes(x=deaths, 
                        y=exp(bhat[1])*(deaths^bhat[2]), 
                        color='red')) + 
  ggtitle('Figure 11.1: Log-Log Model for Smoking Deaths and Costs', 
          subtitle='In Original Space') + 
  labs(x='Deaths', y='Average cost (in Millions of USD)') + 
  theme(legend.position = 'none')

# And plot the KNN predictions in the original space
knn_data <- data.frame(Deaths = costs_deaths$deaths, Predicted = knn_pred)
ggplot(costs_deaths, aes(x=deaths, y=avg_cost)) + 
  geom_point() + 
  geom_line(data = knn_data, 
            mapping = aes(x = Deaths, y = Predicted), 
            color = "blue") + 
  ggtitle('Figure 11.2: KNN Model for Smoking Deaths and Costs', 
          subtitle='Optimal K = 4') + 
  labs(x='Deaths', y='Average cost (in Millions of USD)') + 
  theme(legend.position = 'none')
```


### Section C: US Vaping Trends

From what we have seen so far, the number of individuals in the United States, by and large is decreasing. While the number of daily smokers was decreasing and the number of non-smokers is increasing, the long term costs of mass cigarette consumption are now being felt, with the high number of deaths being observed, and the massive economic burden it places on state health care systems. It is important now to answer the question, where are we going? While cigarette smoking (henceforth called smoking) is decreasing, the consumption of e-cigarettes and vapes is reported to have grown significantly, especially among youth. We will explore the results of the National Youth Tobacco Survey, to understand the overall trends in smoking and vaping among youth. The scope of our data will encompass from 2011 - 2020 and include youth from ages 11 and older. Firstly, we will examine the trends in smoking and vaping over the years faceted by sex.

```{r, warning=F}
library(readxl)

# Unfortunately the data files from the CDC are originally partitioned by year 
# So I needed to manually copy and paste them together, one on top of the other
# They don't have years attached and I wasn't sure how to attach in Excel
# But I knew how many record were in each year's data set,
# So this is the work around solution
# Original code is commented in case error occurs.

year <- c(rep(2011,18866), rep(2012, 24658), rep(2013, 18406), 
          rep(2014, 22007), rep(2015, 17711), rep(2016, 20675), 
          rep(2017, 17872), rep(2018, 20189), rep(2019, 19018),
          rep(2020, 14531))

vape <- read_excel('SmokingData/vape.xlsx', 
                   col_types	= c('guess', 'guess', 'guess',
                                 'guess', 'numeric', 'numeric'))

vapes <- cbind(vape, year)

# We tidy our data set to get it into a usable form
vapes <- vapes %>% 
  drop_na(age) %>% 
  drop_na(sex) %>%
  filter(!age %in% c(1,2)) %>%
  mutate(cigarette = replace_na(cigarette, 2)) %>% 
  mutate(vape = replace_na(vape, 2))

vapes <- vapes %>% mutate(age = age+8, 
                 sex = factor(sex, 
                              levels = c(1,2), 
                              labels = c('Male', 'Female')), 
                 cigarette = factor(cigarette, 
                                    levels = c(1,2), 
                                    labels = c('Yes', 'No')), 
                 vape = factor(vape,
                               levels = c(1,2), 
                               labels = c('Yes', 'No')))

vapes$cigarette <- relevel(vapes$cigarette, "No")
vapes$vape <- relevel(vapes$vape, "No")
```


```{r, fig.show="hold", out.width="90%"}
# We get the total number of individuals by year and sex
total <- vapes %>% 
  group_by(year, sex) %>% 
  count()

# Get the total number of smokers
cig1 <- vapes %>% 
  group_by(year, sex) %>% 
  filter(cigarette %in% 'Yes') %>% 
  count()

# And join the data sets to work out a smoking percentage
cig2 <- inner_join(cig1, total, by=c('year', 'sex')) %>% 
  mutate(percentage = (n.x/n.y)*100, smoke_type = 'Cigarette')

# Do the same for vapes to work out a vaping percentage
vape1 <- vapes %>% 
  group_by(year, sex) %>% 
  filter(vape %in% 'Yes') %>% 
  count()

vape2 <- inner_join(vape1, total, by=c('year', 'sex')) %>% 
  mutate(percentage = (n.x/n.y)*100, smoke_type = 'Vape')

# Combine the data sets for the plotting
smoking_vaping <- union_all(cig2, vape2) %>% 
  mutate(smoke_type = factor(smoke_type))

# Now we can plot smoking and vaping trends for men and women by year
ggplot(smoking_vaping, aes(x=year, y=percentage, col=sex)) + 
  geom_line(aes(linetype=smoke_type)) +
  scale_x_continuous(breaks = seq(2011,2020,1)) + 
  ggtitle('Figure 12: Smoking and Vaping Trends among Youth', 
          subtitle='2011-2020') + 
  labs(x='Year', 
       y='Percentage of youth that have tried tobacco products', 
       col='Sex',
       linetype='Smoking Form')
```

From Figure 12, it is clearly visible that smoking among youth are decreasing over time, but that vaping is steadily increasing. Males are also far more likely to both smoke and vape compared with females, however there is very little variation within sexes, as both Males and Females follow the same trajectories when it comes to smoking and vaping. Of note is a decrease in vaping rates among youth in 2016, which coincides with the US Food and Drug Administration (FDA) extending its regulatory powers to e-cigarette products in August 2016, which banned access of vapes to minors and required photo ID to purchase. A further dip is observed between 2019 and 2020. Contextually there was a widely reported outbreak of E-cigarette and Vaping Associated Lung Injury (EVALI), in which according to the CDC as of February 2020 there were a confirmed 2807 cases hospitalized and had been responsible for over 68 deaths. It is likely that the widely publicized stories on EVALI contributed to the decrease in vape users from 2019 to 2020.

Exploring the consumption of vaping products by age furthermore reveals interesting trends.

```{r, fig.show="hold", out.width="90%"}
# Get the total number of individuals per age group
total <- vapes %>% group_by(age) %>% count()

# Get the number of smokers
cig_age <- vapes %>% 
  group_by(age) %>% 
  filter(cigarette %in% 'Yes') %>% 
  count()

# And calculate as a percentage per age
cig_age2 <- inner_join(cig_age, total, by='age') %>% 
  mutate(percentage = (n.x/n.y)*100, smoke_type = 'Cigarette')

# Do the same for vapers
vape_age <- vapes %>% group_by(age) %>% 
  filter(vape %in% 'Yes') %>% 
  count()

vape_age2 <- inner_join(vape_age, total, by='age') %>% 
  mutate(percentage = (n.x/n.y)*100, smoke_type = 'Vape')

# Combine the data sets for plotting
smoking_vaping_age <- union_all(cig_age2, vape_age2) %>% 
  mutate(smoke_type = factor(smoke_type))

# Finally, plot the data to see smoking and vaping trends by age groups
ggplot(smoking_vaping_age, aes(x=age, y=percentage, col=smoke_type)) + 
  geom_line() + 
  scale_x_continuous(breaks = seq(9,19,1)) + 
  ggtitle('Figure 13: Smoking and Vaping Trends by Age (2011-2020)', 
          subtitle='') + 
  labs(x='Age', 
       y='Percentage of youth that have tried tobacco products', 
       col='Smoking Form') + 
  scale_color_manual(values=c(rgb(0, 0, 0), rgb(0, 0.45, 0.7)))
```

We can see from Figure 13 that as youth get older, they are much more likely to either smoke or vape. The percentage of individuals vaping decreases for older youth however, with a downward trend beyond 18. This is likely due to individuals previously being able to purchase cigarettes legally at 18 years of age. However, in 2019 the age to purchase cigarettes was changed at a federal level from 18 to 21. There will likely be a change in smoking and vaping trends among youth in response to this law, and will likely narrow the gap between smoking and vaping rates among older youth, as cigarette accessibility has been reduced.

Frequent commentary on the youth consumption of e-cigarettes and vapes critiques the supposed gateway drug status of vaping in leading youths to smoking. Using the data from the National Youth Tobacco Survey's we will test this hypothesis and attempt to predict the smoking status of individuals, based on their age, sex and whether or not they have vaped before. Similar to the predictions above on the costs of smoking, we will use both a parametric and non-parametric form, and compare their predictive accuracy. Firstly, we will attempt to predict smoking status via logistic regression. But before doing so, it is important to determine whether this type of question should even be asked.

```{r}
# We're going to get the smoking status of all non-vapers
vape_no <- vapes %>% 
  filter(vape=='No') %>% 
  group_by(vape,cigarette) %>% 
  count() %>% pivot_wider(names_from=cigarette, values_from = n) %>%
  mutate(total = Yes+No, percentage = round(Yes/(No+Yes),2)*100)

# And the smoking status of all vapers
vape_yes <- vapes %>% 
  filter(vape=='Yes') %>% 
  group_by(vape, cigarette) %>% 
  count() %>% pivot_wider(names_from=cigarette, values_from = n) %>%
  mutate(total = Yes+No, percentage = round(Yes/(No+Yes),2)*100)

# Combine the two data sets
vapes_smoke <- union_all(vape_no, vape_yes)

# And display in a table
kable(vapes_smoke, 
      align='c', 
      format='simple', 
      caption='Smokers among Vapers and Non-Vapers', 
      col.names = c('Vaper?', 'Non-Smokers', 'Smokers', 'Total', 'Percentage'))
```

From the data in Table 2, we observe that smokers are far more prevalent among vapers, comprising of 54% of vaping youth, compared with only 13% of the non-vaping youth. It is therefore likely that we will be able to determine an individuals smoking status based on, among other predictors, their vaping status. As such, we will fit two different models for our smoking status prediction and compare their misclassification error to determine which model performs best. 

It should also be noted that we have almost four times as many non-smokers as opposed to smokers. As we have a large data set, we are going to use undersampling, combining all smoking observations with an equally sized sample of non-smokers for our training and testing data, to ensure we have a class balance for our response. Furthermore, when dividing into a training and test set, we will stratify on the response to ensure a proportional amount of both smokers and non-smokers in our training and testing data sets.

```{r}
smokers <- vapes %>% filter(cigarette == 'Yes')
non_smokers <- vapes %>% filter(cigarette == 'No')
non_smokers_sample <- non_smokers %>% sample_n(nrow(smokers))

vapes_sample <- union_all(smokers, non_smokers_sample)
```


```{r}
# Reaffirm seed is my student number
library(caret)
library(groupdata2)
set.seed(4760396)

# We're going to put 20% of our data 'in the drawers' for full out validation
# Stratify on the outcome variable
t_index <- createDataPartition(vapes_sample$cigarette, p=0.80,list=F)
training_data <- vapes_sample[t_index, ]
test_data <- vapes_sample[-t_index, ]
```


The first model we will fit is regressing smoking status based on age, sex and vaping status.
```{r}
# Fit the logistic model
logistic_fit1 <- glm(cigarette ~ age + sex + vape, data = training_data, family = binomial(link = "logit"))
summary(logistic_fit1)
```

If we fit our smaller model on the full training data set, the equation for the fitted model is $$log\ odds(CIGARETTE) = -5.025920 + 0.306871 \times AGE -0.085210 \times FEMALE + 1.809784 \times VAPE$$.

In looking at model fit, we have a null deviance of 88379 on 63751 degrees of freedom, and a residual deviance of 72655 on 63748 degrees of freedom.

For the hypothesis tests on $\beta_j = 0$, the p-value is less than $\alpha = 0.05$ for each predictors and so we would conclude that there is sufficient evidence to reject the null hypotheses that $\beta_j = 0$ at the 5% level of significance for each predictor.

The second model we will fit includes all the previous predictors as well as all possible interactions between them.

```{r}
# And the other model
logistic_fit2 <- glm(cigarette ~ age*sex*vape, data = training_data, family = binomial(link = "logit"))
summary(logistic_fit2)
```

If we fit our larger model on the full training data set, the equation for the fitted model is $$log\ odds(CIGARETTE) = -5.391050 + 0.331060\times AGE -0.200357\times FEMALE + 3.484988\times VAPE$$

$$+ 0.008154(AGE\times FEMALE) -0.109277(AGE \times VAPE) + 1.165210(FEMALE \times VAPE) -0.079340(AGE \times FEMALE  \times VAPE)$$

In looking at model fit, we have a null deviance of 88379 on 63751 degrees of freedom, and a residual deviance of 72489 on 63744 degrees of freedom.

For the hypothesis tests on $\beta_j = 0$, the p-value is less than $\alpha = 0.05$ for each predictors except sexFemale and age:sexFemale, so we would conclude that there is sufficient evidence to reject the null hypotheses that $\beta_j = 0$ at the 5% level of significance for each predictor except the aforementioned.

We can perform a deviance test to compare the smaller and larger model, to determine which is preferred. This tests whether the additional terms of the interaction model are equal to 0.

```{r}
# Test the residual deviance
anova(logistic_fit1, logistic_fit2, test = "Chisq")
```

We receive a p-value of less than 2.2e-16 for our Deviance test. At the 5% significance level, we conclude that the additional interaction terms are jointly significant and so we will retain the interaction model as the preferred model.

We will now perform 5-fold cross validation on the training data to assess the performance of our model. The classification threshold will be 50%.
```{r}
library(caret)
library(groupdata2)
set.seed(4760396)

# We partition our data set into five parts
parts <- partition(training_data, p=c(0.2,0.2,0.2,0.2,0.2))

# Set up our storage vectors
logistic_accuracy <- rep(0,5)
logistic_sensitivity <- rep(0,5)
logistic_specificity <- rep(0,5)

for (i in seq(1:5)){ # Were going to do 5 runs of the training/test 
  indices <- 0 # We need an empty value
  for (j in seq(1:5)){ # For the 5 possible parts that we could select
    if (j!=i){ # We need to grab the four that aren't i
      indices <- rbind(indices, j) # So add them to the indices vector
    }
  }
  
  # the ith partition will be our test partition for this run
  test <- as.data.frame(parts[[i]])
  
  # Now we use the indices vector to know which partitions to use for training
  # Irrespective of the loop number we're in
  training <-as.data.frame(rbind(parts[[indices[2]]], 
                                 parts[[indices[3]]], 
                                 parts[[indices[4]]], 
                                 parts[[indices[5]]]))
  
  # Fit logistic regression
  logistic_fit <- glm(cigarette ~ age*sex*vape, data = training, 
                      family = binomial(link = "logit"))
  
  logistic_probability <- predict(logistic_fit, newdata = test, type='response')
  
  # Assign a prediction based on probability
  logistic_predict <- ifelse(logistic_probability > 0.5, 'Yes', 'No')
  logistic_predict <- as.factor(logistic_predict)
  
  # Construct a Confusion Matrix
  c_matrix_logistic <- confusionMatrix(data=logistic_predict, 
                                       reference = test$cigarette, 
                                       positive = 'Yes')
  
  # Gather the Accuracy, Sensitivity and Specificity
  logistic_accuracy[i] = c_matrix_logistic$overall['Accuracy']
  logistic_sensitivity[i] = c_matrix_logistic$byClass['Sensitivity']
  logistic_specificity[i] = c_matrix_logistic$byClass['Specificity']
}

print(paste0('Average Logistic Accuracy: ', mean(logistic_accuracy)))
print(paste0('Average Logistic Sensitivity: ', mean(logistic_sensitivity)))
print(paste0('Average Logistic Specificity: ', mean(logistic_specificity)))
```

The model has performed moderately well averaging an accuracy around of 70% in its prediction, and attained a moderate sensitivity of 66%, but a stronger specificity of around 75%. This means that the logistic regression model is moderately good at correctly identifying non-smokers, but slightly worse at detecting smokers.

We will again compare the performance of the logistic regression tool with a non-parametric tool in the form of classification trees.

If we perform the five-fold cross validation on for the classification tree, we get the following result.

```{r}
library(rpart)
library(rpart.plot)
set.seed(4760396)

# Set up storage vectors
tree_accuracy <- rep(0,5)
tree_sensitivity <- rep(0,5)
tree_specificity <- rep(0,5)

# We're going to forcibly grow this tree very large
depth <- rpart.control(cp=0.02)

for (i in seq(1:5)){ # Were going to do 5 runs of the training/test 
  indices <- 0 # We need an empty value
  for (j in seq(1:5)){ # For the 5 possible parts that we could select
    if (j!=i){ # We need to grab the four that aren't i
      indices <- rbind(indices, j) # So add them to the indices vector
    }
  }
  
  # the ith partition will be our test partition for this run
  test <- as.data.frame(parts[[i]])
  
  # Now we can use the indices vector to know which partitions to use
  # Irrespective of the loop number we're in
  training <-as.data.frame(rbind(parts[[indices[2]]], 
                                 parts[[indices[3]]], 
                                 parts[[indices[4]]], 
                                 parts[[indices[5]]]))
  
  # Fit tree
  smoke_tree <- rpart(cigarette ~ age + sex + vape + past_month + lifetime, 
                      data=training, method="class", control=depth)

  # Get predictions
  tree_predict <- rpart.predict(smoke_tree, newdata = test, type='class')

  # Fit confusion matrix
  c_matrix_tree <- confusionMatrix(data=tree_predict, 
                                   reference = test$cigarette, 
                                   positive = 'Yes')
  
  # Get stats from matrix
  tree_accuracy[i] = c_matrix_tree$overall['Accuracy']
  tree_sensitivity[i] = c_matrix_tree$byClass['Sensitivity']
  tree_specificity[i] = c_matrix_tree$byClass['Specificity']
  
}

print(paste0('Average Tree Accuracy: ', mean(tree_accuracy)))
print(paste0('Average Tree Sensitivity: ', mean(tree_sensitivity)))
print(paste0('Average Tree Specificity: ', mean(tree_specificity)))

```

The tree has performed slightly worse with the accuracy, achieving an accuracy of 69%. While the Specificity has improved to 80%, it has come at the cost of Sensitivity, with the model only correctly identifying smokers 58% of the time. The following tree was grown.

```{r}
# Plot our classification tree
rpart.plot(smoke_tree, type=5, extra=101)
```

Given the large difference between the predictive ability of the model for smokers and non-smokers, we will use the logistic interaction model as the final model, as it generalises better to any unseen case. We assess its test accuracy.
```{r}
# Fit logistic regression
logistic_fit <- glm(cigarette ~ age*sex*vape, 
                    data = training_data, family = binomial(link = "logit"))
logistic_probability <- predict(logistic_fit, newdata = test_data, type='response')
  
# Assign a prediction based on probability
logistic_predict <- ifelse(logistic_probability > 0.5, 'Yes', 'No')
logistic_predict <- as.factor(logistic_predict)
  
# Construct a Confusion Matrix
c_matrix_logistic <- confusionMatrix(data=logistic_predict, 
                                     reference = test_data$cigarette, 
                                     positive = 'Yes')

c_matrix_logistic
```

Looking at the results of the confusion matrix, we can see that our logistic model have produced nearly identical results to it's performance in the 5-fold validation, that is, an accuracy of 70%, a sensitivity of 66% and a specificity of 74%. We can summarise this performance using an ROC curve, displaying the AUC statistic.

```{r, warning=FALSE, message=FALSE}
library(pROC)
roc(test_data$cigarette, 
    logistic_probability, 
    direction="<", 
    plot=TRUE, 
    auc.polygon=TRUE, 
    print.auc=TRUE, 
    max.auc.polygon=TRUE, 
    show.thres=TRUE)
```

As we can see, we have achieved moderate success with our logistic model, in predicting the smoking status of youth through their age, sex and vaping status.

\newpage
## Discussion

Overall, there are interesting trends emerging both with regards to smoking and vaping. In exploring our first question of where the United States stood globally on smoking rates, we can see that they are far from the highest smoking nation and currently contain roughly a third of the smoking population percentage as the currently leading smokers. Furthermore we observed that globally trends in smoking rates are consistently decreasing.

When looking at the patterns in the United States throughout the late 1990s and 2000s, we can see this overall downward trend in smoking rates. It is unsurprising to see this, given the wide scale public education campaign that has occurred through the late 20th century in educating people as to the harmful effects of smoking. Furthermore, as more and more information emerged on the long-term impacts of smoking, it became easier to directly identify certain illnesses as a direct result of cigarette consumption. Smoking no longer is the 'norm' with only roughly 20% of US adults smoking and no longer glorified on film and television, given the heavy regulation that cigarettes have. So it's unsurprising that the number of non-smokers is increasing as new generations shun the habit, and older generations unfortunately pass away from smoking related illnesses.

Furthermore it is unsurprising that the US is now experiencing such high economic burden from smoking related illnesses, given the delayed time between the high point of smoking in the 1950s and the time needed for individuals to develop smoking related illnesses. Given the direct correlation between individuals getting sick and dying from smoking and the cost to hospitalize and care for individuals suffering from this, both  the log-log and KNN models we're very strong in predicting the average cost for a state given the number of individuals dying from smoking related illnesses. Such models would be very useful to US State Governments so that they may allocate appropriate funding to healthcare sectors which manage smoking related illnesses. Furthermore, as prescription drugs are included in the costings, these models are also valuable to pharmaceutical companies that can adjust their production of medication to match the demand.

Finally, the large consumption of emerging smoking technologies including vapes by youth is a concern as there have not been enough longitudinal studies on the long term health effects on vaping. As highlighted above, e-cigarettes were first introduced into the market in 2003, and so there is at most 20 years of data available on the consumption of e-cigarettes and vaping products. Any data claiming that vapes are 'healthier' than cigarettes cannot then account what long term consequences may occur. In regards to detecting whether a youth has tried cigarettes through, among several predictors, whether or not they have vaped before, both the logistic model and the classification trees had an average performance. Both models were better at detecting non-smoker than non-smokers, despite the undersampling employed to ensure an even amount of both in the test data. It may be because the response variable, whether an individual has ever smoked or not, is too general and does not account for the complexity of circumstances or frequencies to which individuals will consume vapes or cigarettes. Numerous other predictors related to smoking and its prevalence, such as social circles, parental smoking status and socio-economic background may yield better results that the models used. Alternatively, there may just not be any link strong between vaping and smoking.

## Conclusion
The United States is a microcosm of larger global trends in shrinking smoking rates. It is currently enduring its most challenging era of smoking, as it deals with the consequences of long term mass cigarette consumption, where the costs of such a challenge can be effectively modeled and accurately predicted by either linear regression or KNN. Fortunately the US is also seeing decreases in smoking populations among every region, and new generations emerging that are taking up smoking. Vaping among youth is on the rise and a situation that will be closely observed as more and more data emerges on the long term effects of vaping. While debate continues as to whether vaping has a causal relationship with smoking, our logistic regression and classification tree models, while decent at detecting non-smokers, only had moderate success detecting smokers.

## Dataset Citations
$\textit{WHO Tobacco and Smoking Data 2008-2018}$. Kaggle: World Health Organization; 2008-2018. Licence: CC BY-NC-SA 3.0 IGO. Data accessible at: <https://www.kaggle.com/datasets/ozgurdogan646/who-tobacco-and-smoking-data-20082018?select=SmokingAndTobaccoData2008.csv>

$\textit{BRFSS Prevalence and Trends Data: Tobacco Use - Four Level Smoking Data for 1995-2010}$, Centers for Disease Control and Prevention (CDC). Behavioral Risk Factor Surveillance System. Atlanta, Georgia: U.S. Department of Health and Human Services, Centers for Disease Control and Prevention, 2015. Data accessible at: <https://data.cdc.gov/Smoking-Tobacco-Use/BRFSS-Prevalence-and-Trends-Data-Tobacco-Use-Four-/8zak-ewtm>

Smoking-Attributable Mortality, Morbidity, and Economic Costs (SAMMEC) - Smoking-Attributable Expenditures (SAE), Centers for Disease Control and Prevention (CDC). Atlanta, Georgia: U.S. Department of Health and Human Services, Centers for Disease Control and Prevention, 2020. Data accessible at: <https://chronicdata.cdc.gov/Health-Consequences-and-Costs/Smoking-Attributable-Mortality-Morbidity-and-Econo/ezab-8sq5>

Smoking-Attributable Mortality, Morbidity, and Economic Costs (SAMMEC) - Smoking-Attributable Mortality (SAM), Centers for Disease Control and Prevention (CDC). Atlanta, Georgia: U.S. Department of Health and Human Services, Centers for Disease Control and Prevention, 2020. Data accessible at: <https://chronicdata.cdc.gov/Health-Consequences-and-Costs/Smoking-Attributable-Mortality-Morbidity-and-Econo/4yyu-3s69>

$\textit{National Youth Tobacco Survey (NYTS)}$, Centers for Disease Control and Prevention (CDC). Office on Smoking and Health, National Center for Chronic Disease Prevention and Health Promotion. Atlanta, Georgia: U.S. Department of Health and Human Services, Centers for Disease Control and Prevention, 2022.
Data accessible at: <https://www.cdc.gov/tobacco/data_statistics/surveys/nyts/data/index.html>

$\textit{State Intercensal Tables: 2000-2010}$, United States Census Bureau, 2021.
Data accessible at: <https://www.census.gov/data/tables/time-series/demo/popest/intercensal-2000-2010-state.html>
